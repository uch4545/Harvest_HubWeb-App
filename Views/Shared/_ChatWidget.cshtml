<style>
    /* Chat Widget Styles */
    .ai-chat-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        font-family: 'Inter', sans-serif;
    }

    .ai-chat-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #25d366, #128c7e);
        border: none;
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        position: relative;
    }

    .ai-chat-button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
    }

    .ai-chat-button svg {
        width: 32px;
        height: 32px;
        fill: white;
    }

    .ai-chat-button.active {
        background: linear-gradient(135deg, #dc2626, #991b1b);
    }

    .ai-chat-pulse {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: rgba(37, 211, 102, 0.3);
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.3); opacity: 0; }
    }

    .ai-chat-window {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 380px;
        height: 550px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        display: none;
        flex-direction: column;
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }

    .ai-chat-window.active {
        display: flex;
    }

    @@keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ai-chat-header {
        background: linear-gradient(135deg, #075e54, #128c7e);
        color: white;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .ai-chat-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4px;
        overflow: hidden;
    }

    .ai-chat-avatar img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .ai-chat-info h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
    }

    .ai-chat-info p {
        margin: 4px 0 0 0;
        font-size: 12px;
        opacity: 0.9;
    }

    .ai-chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f0f2f5;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .ai-chat-message {
        display: flex;
        animation: messageIn 0.3s ease;
    }

    @@keyframes messageIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ai-chat-message.user {
        justify-content: flex-end;
    }

    .ai-chat-message.bot {
        justify-content: flex-start;
    }

    .ai-message-bubble {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 12px;
        word-wrap: break-word;
        white-space: pre-wrap;
        line-height: 1.5;
        font-size: 14px;
    }

    .ai-chat-message.user .ai-message-bubble {
        background: #25d366;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .ai-chat-message.bot .ai-message-bubble {
        background: white;
        color: #1a1a1a;
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .ai-message-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 4px;
        text-align: right;
    }

    .ai-typing-indicator {
        display: flex;
        gap: 4px;
        padding: 12px 16px;
        background: white;
        border-radius: 12px;
        width: fit-content;
    }

    .ai-typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #999;
        animation: typing 1.4s infinite;
    }

    .ai-typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .ai-typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @@keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
    }

    .ai-chat-input-container {
        padding: 16px;
        background: white;
        border-top: 1px solid #e5e7eb;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .ai-chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 24px;
        outline: none;
        font-size: 14px;
        font-family: 'Inter', sans-serif;
        transition: all 0.2s;
    }

    .ai-chat-input:focus {
        border-color: #25d366;
        box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
    }

    .ai-chat-send-btn {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: #25d366;
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .ai-chat-send-btn:hover:not(:disabled) {
        background: #20b858;
        transform: scale(1.05);
    }

    .ai-chat-send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .ai-chat-welcome {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }

    .ai-chat-welcome h4 {
        margin: 0 0 8px 0;
        color: #1a1a1a;
        font-size: 18px;
    }

    .ai-chat-welcome p {
        margin: 0 0 20px 0;
        font-size: 14px;
    }

    .ai-chat-suggestions {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .ai-chat-suggestion {
        padding: 10px 16px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 13px;
        text-align: left;
    }

    .ai-chat-suggestion:hover {
        background: #f9fafb;
        border-color: #25d366;
        transform: translateX(4px);
    }

    @@media (max-width: 640px) {
        .ai-chat-window {
            width: calc(100vw - 40px);
            height: calc(100vh - 100px);
            bottom: 80px;
        }
    }

    /* Scrollbar Styling */
    .ai-chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .ai-chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }

    .ai-chat-messages::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }

    .ai-chat-messages::-webkit-scrollbar-thumb:hover {
        background: #999;
    }
</style>

<div class="ai-chat-widget">
    <!-- Chat Window -->
    <div class="ai-chat-window" id="aiChatWindow">
        <!-- Header -->
        <div class="ai-chat-header">
            <div class="ai-chat-avatar">
                <img src="/image/harvest/N__1_-removebg-preview.png" alt="Harvest Hub Logo">
            </div>
            <div class="ai-chat-info">
                <h3>Harvest AI Assistant</h3>
                <p>Agri-Expert | ÿßÿ±ÿØŸà Support</p>
            </div>
        </div>

        <!-- Messages -->
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-chat-welcome">
                <h4>Assalam-o-Alaikum! üëã</h4>
                <p>Main aapki madad ke liye hazir hoon. Agriculture se related koi bhi sawal poochiye!</p>
                <div class="ai-chat-suggestions">
                    <div class="ai-chat-suggestion" onclick="sendSuggestion('Wheat ki kashtakari kab karni chahiye?')">
                        üåæ Wheat ki kashtakari kab karni chahiye?
                    </div>
                    <div class="ai-chat-suggestion" onclick="sendSuggestion('Cotton mein keede kaise control karein?')">
                        üêõ Cotton mein keede kaise control karein?
                    </div>
                    <div class="ai-chat-suggestion" onclick="sendSuggestion('Sarkari schemes farmers ke liye?')">
                        üèõÔ∏è Sarkari schemes farmers ke liye?
                    </div>
                </div>
            </div>
        </div>

        <!-- Input -->
        <div class="ai-chat-input-container">
            <input 
                type="text" 
                class="ai-chat-input" 
                id="aiChatInput" 
                placeholder="Type your question..."
                onkeypress="handleKeyPress(event)"
            />
            <button class="ai-chat-send-btn" id="aiChatSendBtn" onclick="sendMessage()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Chat Button -->
    <button class="ai-chat-button" id="aiChatButton" onclick="toggleChat()">
        <div class="ai-chat-pulse"></div>
        <svg id="chatIcon" viewBox="0 0 24 24">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
        </svg>
        <svg id="closeIcon" style="display: none;" viewBox="0 0 24 24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
    </button>
</div>

<script>
    // Global chat state
    let conversationHistory = [];
    let isTyping = false;

    function toggleChat() {
        const chatWindow = document.getElementById('aiChatWindow');
        const chatButton = document.getElementById('aiChatButton');
        const chatIcon = document.getElementById('chatIcon');
        const closeIcon = document.getElementById('closeIcon');

        chatWindow.classList.toggle('active');
        chatButton.classList.toggle('active');

        if (chatWindow.classList.contains('active')) {
            chatIcon.style.display = 'none';
            closeIcon.style.display = 'block';
            document.getElementById('aiChatInput').focus();
        } else {
            chatIcon.style.display = 'block';
            closeIcon.style.display = 'none';
        }
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    function sendSuggestion(text) {
        document.getElementById('aiChatInput').value = text;
        sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('aiChatInput');
        const message = input.value.trim();

        if (!message || isTyping) return;

        // Clear input
        input.value = '';

        // Remove welcome screen if present
        const welcome = document.querySelector('.ai-chat-welcome');
        if (welcome) {
            welcome.remove();
        }

        // Add user message
        addMessage(message, 'user');

        // Show typing indicator
        showTypingIndicator();

        try {
            // Call API
            const response = await fetch('/api/aichatbot/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    conversationHistory: conversationHistory
                })
            });

            const data = await response.json();

            // Hide typing indicator
            hideTypingIndicator();

            if (data.success) {
                // Add bot response
                addMessage(data.response, 'bot');

                // Update conversation history
                conversationHistory.push({ role: 'User', message: message });
                conversationHistory.push({ role: 'Assistant', message: data.response });

                // Keep only last 10 messages in history
                if (conversationHistory.length > 10) {
                    conversationHistory = conversationHistory.slice(-10);
                }
            } else {
                addMessage('Maaf kijiye, kuch galat ho gaya. Baad mein koshish karein.', 'bot');
            }
        } catch (error) {
            hideTypingIndicator();
            addMessage('Network error. Apna internet connection check karein.', 'bot');
            console.error('Chat error:', error);
        }
    }

    function addMessage(text, sender) {
        const messagesContainer = document.getElementById('aiChatMessages');
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `ai-chat-message ${sender}`;

        const bubble = document.createElement('div');
        bubble.className = 'ai-message-bubble';
        bubble.textContent = text;

        const time = document.createElement('div');
        time.className = 'ai-message-time';
        time.textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

        bubble.appendChild(time);
        messageDiv.appendChild(bubble);
        messagesContainer.appendChild(messageDiv);

        // Auto scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showTypingIndicator() {
        isTyping = true;
        const messagesContainer = document.getElementById('aiChatMessages');
        
        const typingDiv = document.createElement('div');
        typingDiv.className = 'ai-chat-message bot';
        typingDiv.id = 'typingIndicator';

        const indicator = document.createElement('div');
        indicator.className = 'ai-typing-indicator';
        indicator.innerHTML = '<div class="ai-typing-dot"></div><div class="ai-typing-dot"></div><div class="ai-typing-dot"></div>';

        typingDiv.appendChild(indicator);
        messagesContainer.appendChild(typingDiv);

        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Disable send button
        document.getElementById('aiChatSendBtn').disabled = true;
    }

    function hideTypingIndicator() {
        isTyping = false;
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
            indicator.remove();
        }

        // Enable send button
        document.getElementById('aiChatSendBtn').disabled = false;
    }
</script>
